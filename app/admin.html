<!doctype html>
<meta charset="utf-8" />
<title>Accounts Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji"}
  .tab-btn[aria-selected="true"]{border-bottom:2px solid #111827;color:#111827}
  .badge{border-radius:.5rem;padding:.2rem .45rem;font-size:.75rem}
  .badge.green{background:#DCFCE7;color:#166534}
  .badge.gray{background:#F3F4F6;color:#374151}
  .badge.red{background:#FEE2E2;color:#991B1B}
  .badge.amber{background:#FEF3C7;color:#92400E}
  .badge.blue{background:#DBEAFE;color:#1E3A8A}
  .btn{border:1px solid #E5E7EB;border-radius:.7rem;padding:.55rem .8rem;font-weight:600}
  .btn:hover{background:#F3F4F6}
  .btn.primary{background:#111827;color:#fff;border-color:#111827}
  .btn.primary:hover{background:#000}
  .card{border:1px solid #E5E7EB;border-radius:1rem;padding:1rem;background:#fff}
  .input{border:1px solid #E5E7EB;border-radius:.6rem;padding:.55rem .7rem;width:100%}
  .switch{position:relative;display:inline-block;width:40px;height:22px}
  .switch input{opacity:0;width:0;height:0}
  .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#e5e7eb;transition:.2s;border-radius:34px}
  .slider:before{position:absolute;content:"";height:18px;width:18px;left:2px;bottom:2px;background:white;transition:.2s;border-radius:50%}
  input:checked + .slider{background:#111827}
  input:checked + .slider:before{transform:translateX(18px)}
</style>
<body class="bg-gray-50">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <header class="flex items-center gap-4 mb-6">
      <h1 class="text-2xl font-bold tracking-tight">Accounts Dashboard</h1>
      <span id="envTag" class="badge gray">live</span>
      <div class="ml-auto flex items-center gap-2">
        <input id="apiKey" class="input w-80" placeholder="Paste Admin X-API-Key: admin.<SECRET>" />
        <button class="btn" onclick="saveKey()">Save</button>
        <span id="authState" class="text-sm text-gray-500"></span>
      </div>
    </header>

    <nav class="flex gap-6 border-b border-gray-200 mb-6">
      <button class="tab-btn py-2 -mb-px text-gray-500" aria-selected="true" onclick="showTab('overview', this)">Overview</button>
      <button class="tab-btn py-2 -mb-px text-gray-500" onclick="showTab('keys', this)">Keys</button>
      <button class="tab-btn py-2 -mb-px text-gray-500" onclick="showTab('grants', this)">Grants</button>
      <button class="tab-btn py-2 -mb-px text-gray-500" onclick="showTab('stats', this)">Stats</button>
    </nav>

    <!-- Overview -->
    <section id="tab-overview">
      <div class="flex items-center justify-end mb-2 gap-3">
        <label class="flex items-center gap-2 text-sm text-gray-600">
          <input id="autoRefresh" type="checkbox" onchange="toggleAutoRefresh(this.checked)"> Auto refresh
        </label>
        <span id="lastRef" class="text-xs text-gray-400"></span>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="card">
        <div class="text-sm text-gray-500">Uploaded (range)</div>
        <div id="kUploaded" class="text-2xl font-semibold">–</div>
      </div>
      <div class="card">
        <div class="text-sm text-gray-500">Used</div>
        <div id="kUsed" class="text-2xl font-semibold">–</div>
      </div>
      <div class="card">
        <div class="text-sm text-gray-500">Locked</div>
        <div id="kLocked" class="text-2xl font-semibold">–</div>
      </div>
      <div class="card">
        <div class="text-sm text-gray-500">Reg Success / 282</div>
        <div class="text-2xl font-semibold"><span id="kReg">–</span> / <span id="k282">–</span></div>
      </div>
    </section>

    <!-- Keys -->
    <section id="tab-keys" class="hidden">
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">API Keys</h2>
          <div class="flex gap-2">
            <button class="btn" onclick="createKeyPrompt()">+ New Key</button>
            <button class="btn" onclick="loadKeys()">Refresh</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-gray-500">
                <th class="py-2 pr-4">Key ID</th>
                <th class="py-2 pr-4">Label</th>
                <th class="py-2 pr-4">Active</th>
                <th class="py-2 pr-4">Can Upload</th>
                <th class="py-2 pr-4">Can Consume</th>
                <th class="py-2 pr-4">RPM</th>
                <th class="py-2 pr-4">Daily Cap</th>
                <th class="py-2 pr-4">Actions</th>
              </tr>
            </thead>
            <tbody id="keysTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Grants -->
    <section id="tab-grants" class="hidden">
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">Consumer ↔ Owner Grants</h2>
          <button class="btn" onclick="loadGrants()">Refresh</button>
        </div>
        <div id="grantsMatrix" class="overflow-x-auto"></div>
      </div>
    </section>

    <!-- Stats -->
    <section id="tab-stats" class="hidden">
      <div class="card">
        <div class="flex flex-wrap gap-3 mb-3 items-end">
          <div>
            <label class="text-xs text-gray-500">From</label>
            <input id="fromDate" type="date" class="input w-44" />
          </div>
          <div>
            <label class="text-xs text-gray-500">To</label>
            <input id="toDate" type="date" class="input w-44" />
          </div>
          <div>
            <label class="text-xs text-gray-500">Owners (comma-sep, optional)</label>
            <input id="ownersInput" class="input w-72" placeholder="e.g. sanjay,shoib" />
          </div>
          <div>
            <label class="text-xs text-gray-500">Consumers (comma-sep, optional)</label>
            <input id="consumersInput" class="input w-72" placeholder="e.g. rahul" />
          </div>
          <button class="btn primary" onclick="runStats()">Run</button>
          <button class="btn" onclick="exportStats()">Export CSV</button>
        </div>
        <div id="statsOut" class="space-y-4"></div>
      </div>
    </section>

  </div>

  <script>
    // ---- tiny utils ----
    const $ = (q) => document.querySelector(q);
    const api = {
      key: '',
      hdr() { return { 'X-API-Key': this.key, 'Content-Type': 'application/json' }; },
      async get(url){ const r = await fetch(url, { headers: this.hdr() }); if(!r.ok) throw await r.text(); return r.json(); },
      async post(url, body){ const r = await fetch(url, { method:'POST', headers: this.hdr(), body: JSON.stringify(body||{}) }); if(!r.ok) throw await r.text(); return r.json(); },
    };

    function showToast(msg, ok=true){
      const el = document.createElement('div');
      el.className = 'fixed bottom-4 right-4 z-50 card shadow-lg ' + (ok?'border-green-200':'border-red-200');
      el.textContent = msg; document.body.appendChild(el);
      setTimeout(()=>el.remove(), 2200);
    }

    function showTab(id, btn){
      document.querySelectorAll('[id^="tab-"]').forEach(s=>s.classList.add('hidden'));
      $('#tab-'+id).classList.remove('hidden');
      document.querySelectorAll('.tab-btn').forEach(b=>b.setAttribute('aria-selected','false'));
      btn.setAttribute('aria-selected','true');
      if(id==='overview') refreshOverview();
      if(id==='keys') loadKeys();
      if(id==='grants') loadGrants();
      if(id==='stats') presetDates();
    }

    function saveKey(){
      const k = $('#apiKey').value.trim();
      if(!k){ showToast('Paste Admin X-API-Key', false); return; }
      api.key = k; localStorage.setItem('ADMIN_X_KEY', k); verifyAuth();
    }
    function restoreKey(){ const k = localStorage.getItem('ADMIN_X_KEY')||''; api.key = k; $('#apiKey').value = k; verifyAuth(false); }

    async function verifyAuth(notify=true){
      try{
        await api.get('/v1/admin/list_keys');
        $('#authState').textContent = 'Authenticated';
        $('#authState').className = 'text-sm text-green-600';
        if(notify) showToast('Admin key saved ✅');
      }catch(e){
        $('#authState').textContent = 'Auth failed';
        $('#authState').className = 'text-sm text-red-600';
        if(notify) showToast('Auth failed ❌', false);
      }
    }

    // ---- Overview (stats quick) ----
    function fmtDate(d){ return d.toISOString().slice(0,10); }
    async function fmtDate(d){ return d.toISOString().slice(0,10); }
    async function refreshOverview(){
      const to = new Date();
      const from = new Date(Date.now()-24*3600*1000);
      try{
        const q = `/v1/stats?date_from=${fmtDate(from)}&date_to=${fmtDate(to)}`;
        const j = await api.get(q);
        $('#kUploaded').textContent = j.totals.uploaded;
        $('#kUsed').textContent = j.totals.used_total;
        $('#kLocked').textContent = j.totals.locked;
        $('#kReg').textContent = j.totals.reg_success;
        $('#k282').textContent = j.totals.code_282;
        $('#lastRef').textContent = 'Last refresh ' + new Date().toLocaleTimeString();
      }catch(e){ showToast('Stats load failed', false); }
    }
    let overviewTimer=null; function toggleAutoRefresh(on){ if(overviewTimer){ clearInterval(overviewTimer); overviewTimer=null;} if(on){ overviewTimer=setInterval(refreshOverview,15000);} }&date_to=${fmtDate(to)}`;
        const j = await api.get(q);
        $('#kUploaded').textContent = j.totals.uploaded;
        $('#kUsed').textContent = j.totals.used_total;
        $('#kLocked').textContent = j.totals.locked;
        $('#kReg').textContent = j.totals.reg_success;
        $('#k282').textContent = j.totals.code_282;
      }catch(e){ showToast('Stats load failed', false); }
    }

    // ---- Keys ----
    async function loadKeys(){
      try{
        const j = await api.get('/v1/admin/list_keys');
        const tbody = $('#keysTbody');
        tbody.innerHTML = '';
        for(const k of j.keys){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="py-2 pr-4 font-mono">${k.key_id}</td>
            <td class="py-2 pr-4"><input class="input" value="${k.label||''}" data-k="${k.key_id}" data-f="label"></td>
            <td class="py-2 pr-4">
              <label class="switch">
                <input type="checkbox" ${k.active? 'checked':''} data-k="${k.key_id}" data-f="active">
                <span class="slider"></span>
              </label>
            </td>
            <td class="py-2 pr-4">
              <label class="switch">
                <input type="checkbox" ${k.can_upload? 'checked':''} data-k="${k.key_id}" data-f="can_upload">
                <span class="slider"></span>
              </label>
            </td>
            <td class="py-2 pr-4">
              <label class="switch">
                <input type="checkbox" ${k.can_consume? 'checked':''} data-k="${k.key_id}" data-f="can_consume">
                <span class="slider"></span>
              </label>
            </td>
            <td class="py-2 pr-4"><input class="input w-24" type="number" value="${k.rpm_limit}" data-k="${k.key_id}" data-f="rpm_limit"></td>
            <td class="py-2 pr-4"><input class="input w-28" type="number" value="${k.daily_cap}" data-k="${k.key_id}" data-f="daily_cap"></td>
            <td class="py-2 pr-4 flex gap-2">
              <button class="btn" onclick="saveRow('${k.key_id}')">Save</button>
              <button class="btn" onclick="regenSecret('${k.key_id}')">Regen Secret</button>
            </td>`;
          tbody.appendChild(tr);
        }
      }catch(e){ showToast('Load keys failed', false); }
    }
    async function saveRow(key_id){
      const q = `[data-k="${key_id}"]`;
      const getVal = (f)=>{
        const el = document.querySelector(`${q}[data-f="${f}"]`);
        if(!el) return null;
        if(el.type==='checkbox') return el.checked?1:0;
        if(el.type==='number') return Number(el.value||0);
        return el.value;
      }
      const body = { key_id, label:getVal('label'), active:getVal('active'), can_upload:getVal('can_upload'), can_consume:getVal('can_consume'), rpm_limit:getVal('rpm_limit'), daily_cap:getVal('daily_cap') };
      try{ await api.post('/v1/admin/update_key', body); showToast('Saved ✓'); }
      catch(e){ showToast('Save failed: '+e, false); }
    }

    // ---- Keys helpers: create & regen ----
    async function createKeyPrompt(){
      const id = prompt('New key_id (e.g. kartik)?');
      if(!id) return;
      const label = prompt('Label (optional)', id) || id;
      try{
        // Prefer backend endpoint if available
        const body = { key_id:id, label, active:1, can_upload:1, can_consume:1, rpm_limit:60, daily_cap:5000 };
        const r = await api.post('/v1/admin/create_key', body);
        showToast('Key created ✓');
        loadKeys();
      }catch(e){
        // Fallback: guide with CLI one-liner
        const tip = `Backend create endpoint missing. SSH and run:

sudo -u acctapi /opt/account-api/venv/bin/python /opt/account-api/scripts/make_key.py ${id}`;
        console.warn(e);
        alert(tip);
      }
    }
    async function regenSecret(key_id){
      if(!confirm(`Regenerate secret for ${key_id}? Old one stops working immediately.`)) return;
      try{
        const r = await api.post('/v1/admin/regen_secret', { key_id });
        // Expect backend to return { key_id, api_key: "<key>.<secret>" }
        if(r && r.api_key){
          navigator.clipboard?.writeText(r.api_key);
          showToast('New secret generated & copied ✓');
        }else{
          showToast('Secret regenerated (check response)', true);
          alert(JSON.stringify(r, null, 2));
        }
      }catch(e){
        const tip = `Regen endpoint missing. SSH and run:

sudo -u acctapi /opt/account-api/venv/bin/python /opt/account-api/scripts/make_key.py ${key_id}`;
        console.warn(e);
        alert(tip);
      }
    }

    // ---- Grants ----
    async function loadGrants(){
      try{
        const keys = (await api.get('/v1/admin/list_keys')).keys.map(k=>k.key_id);
        const grants = (await api.get('/v1/admin/list_grants')).grants;
        const gset = new Set(grants.filter(g=>g.enabled).map(g=>g.consumer_key_id+"->"+g.owner_key_id));
        // build matrix
        let html = '<table class="min-w-full text-sm"><thead><tr><th class="py-2 pr-4">Consumer ↓ / Owner →</th>' +
          keys.map(o=>`<th class="py-2 px-2 text-center">${o}</th>`).join('') + '</tr></thead><tbody>';
        for(const c of keys){
          html += `<tr><td class="py-2 pr-4 font-mono">${c}</td>`;
          for(const o of keys){
            const id = `g_${c}__${o}`;
            const on = gset.has(c+"->"+o);
            html += `<td class="py-1 px-2 text-center"><input type="checkbox" id="${id}" ${on? 'checked':''} onchange="toggleGrant('${c}','${o}', this.checked)"></td>`;
          }
          html += '</tr>';
        }
        html += '</tbody></table>';
        $('#grantsMatrix').innerHTML = html;
      }catch(e){ showToast('Load grants failed', false); }
    }
    async function toggleGrant(consumer, owner, on){
      try{
        if(on){
          await api.post('/v1/admin/grant', {consumer_key_id:consumer, owner_key_id:owner, enabled:1});
        }else{
          await api.post('/v1/admin/revoke', {consumer_key_id:consumer, owner_key_id:owner});
        }
        showToast('Updated ✓');
      }catch(e){ showToast('Grant update failed: '+e, false); }
    }

    // ---- Stats ----
    let lastStats = null;
    function toCSV(rows){
      return rows.map(r=>r.map(x=>String(x).replaceAll('"','""')).map(x=>`"${x}"`).join(',')).join('
');
    }
    function exportStats(){
      if(!lastStats){ showToast('Run stats first', false); return; }
      const parts = [];
      parts.push('# Totals');
      parts.push(toCSV([["uploaded","used_total","locked","reg_success","code_282","used_pending"],[lastStats.totals.uploaded,lastStats.totals.used_total,lastStats.totals.locked,lastStats.totals.reg_success,lastStats.totals.code_282,lastStats.totals.used_pending]]));
      if(lastStats.per_owner?.length){
        parts.push('
# Per Owner');
        const head = ["owner","uploaded","used","locked","reg","code_282","pending"];
        const rows = lastStats.per_owner.map(r=>[r.owner_key_id,r.uploaded,r.used_total,r.locked,r.reg_success,r.code_282,r.used_pending]);
        parts.push(toCSV([head,...rows]));
      }
      if(lastStats.per_consumer?.length){
        parts.push('
# Per Consumer');
        const head = ["consumer","total_used"]; const rows = lastStats.per_consumer.map(r=>[r.used_by_key,r.total]);
        parts.push(toCSV([head,...rows]));
      }
      const blob = new Blob([parts.join('
')], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `stats_${Date.now()}.csv`;
      a.click();
    }
    function presetDates(){
      const to = new Date();
      const from = new Date(Date.now()-24*3600*1000);
      $('#fromDate').value = fmtDate(from);
      $('#toDate').value = fmtDate(to);
      runStats();
    }
    async function runStats(){
      const f = $('#fromDate').value; const t = $('#toDate').value;
      const owners = $('#ownersInput').value.trim();
      const consumers = $('#consumersInput').value.trim();
      const u = new URL('/v1/stats', location.origin);
      u.searchParams.set('date_from', f); u.searchParams.set('date_to', t);
      if(owners) u.searchParams.set('owner_keys', owners);
      if(consumers) u.searchParams.set('consumer_keys', consumers);
      try{
        const s = await api.get(u.toString()); lastStats = s;
        const out = [];
        out.push(`<div class='grid grid-cols-1 md:grid-cols-3 gap-3'>
          <div class='card'><div class='text-sm text-gray-500'>Uploaded</div><div class='text-2xl font-semibold'>${s.totals.uploaded}</div></div>
          <div class='card'><div class='text-sm text-gray-500'>Used / Locked</div><div class='text-2xl font-semibold'>${s.totals.used_total} / ${s.totals.locked}</div></div>
          <div class='card'><div class='text-sm text-gray-500'>Reg Success / 282 / Pending</div><div class='text-2xl font-semibold'>${s.totals.reg_success} / ${s.totals.code_282} / ${s.totals.used_pending}</div></div>
        </div>`);
        // per owner table
        if(s.per_owner?.length){
          out.push(`<div class='mt-4'><div class='font-semibold mb-2'>Per Owner</div>
          <table class='min-w-full text-sm'><thead><tr class='text-left text-gray-500'>
            <th class='py-2 pr-4'>Owner</th><th class='py-2 pr-4'>Uploaded</th><th class='py-2 pr-4'>Used</th><th class='py-2 pr-4'>Locked</th><th class='py-2 pr-4'>Reg</th><th class='py-2 pr-4'>282</th><th class='py-2 pr-4'>Pending</th>
          </tr></thead><tbody>
          ${s.per_owner.map(r=>`<tr><td class='py-2 pr-4 font-mono'>${r.owner_key_id}</td><td class='py-2 pr-4'>${r.uploaded}</td><td class='py-2 pr-4'>${r.used_total}</td><td class='py-2 pr-4'>${r.locked}</td><td class='py-2 pr-4'>${r.reg_success}</td><td class='py-2 pr-4'>${r.code_282}</td><td class='py-2 pr-4'>${r.used_pending}</td></tr>`).join('')}
          </tbody></table></div>`);
        }
        if(s.per_consumer?.length){
          out.push(`<div class='mt-4'><div class='font-semibold mb-2'>Per Consumer</div>
          <table class='min-w-full text-sm'><thead><tr class='text-left text-gray-500'>
            <th class='py-2 pr-4'>Consumer</th><th class='py-2 pr-4'>Total Used</th>
          </tr></thead><tbody>
          ${s.per_consumer.map(r=>`<tr><td class='py-2 pr-4 font-mono'>${r.used_by_key}</td><td class='py-2 pr-4'>${r.total}</td></tr>`).join('')}
          </tbody></table></div>`);
        }
        $('#statsOut').innerHTML = out.join('');
      }catch(e){ showToast('Stats failed: '+e, false); }
    }

    // boot
    (function(){
      restoreKey();
      showTab('overview', document.querySelector('.tab-btn'));
    })();
  </script>
</body>

