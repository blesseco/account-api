<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Accounts Admin</title>
<style>
  :root{--bg:#0f172a;--panel:#111827;--card:#0b1220;--line:#1f2937;--text:#e5e7eb;--muted:#94a3b8;--input:#0b1220;--brand:#60a5fa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--accent:#3b82f6}
  .light{--bg:#f7f8fb;--panel:#ffffff;--card:#ffffff;--line:#d4d7de;--text:#0b1320;--muted:#5b6b86;--input:#ffffff;--brand:#2563eb;--ok:#16a34a;--warn:#d97706;--bad:#dc2626;--accent:#1d4ed8}
  html,body{background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:1200px;margin:26px auto;padding:0 16px}
  h1{font-size:24px;margin:0 0 18px;display:flex;gap:12px;align-items:center}
  .muted{color:var(--muted)} .pill{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--line)}
  .pill.ok{background:color-mix(in oklab,var(--ok) 18%, transparent);border-color:var(--ok)}
  .pill.bad{background:color-mix(in oklab,var(--bad) 18%, transparent);border-color:var(--bad)}
  .row{display:flex;gap:12px;flex-wrap:wrap} .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
  .controls .row > div{flex:1 1 240px}
  label{display:block;margin:0 0 6px;color:var(--muted);font-weight:600}
  input[type=text],input[type=date],input[type=number],input[type=password]{width:100%;background:var(--input);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px 12px;outline:none}
  input:focus{border-color:var(--brand)}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--text);cursor:pointer}
  .btn.brand{background:var(--accent);border-color:var(--accent);color:#fff} .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
  .btn.warn{background:var(--warn);border-color:var(--warn);color:#fff} .btn.bad{background:var(--bad);border-color:var(--bad);color:#fff}
  .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px} .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px 14px}
  .k{font-size:12px;color:var(--muted)} .v{font-size:22px;font-weight:700;margin-top:6px}
  .table{width:100%;border-collapse:separate;border-spacing:0} .table th,.table td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left}
  .table th{font-weight:700;color:var(--muted)} .right{display:flex;gap:8px;justify-content:flex-end}
  .section{margin-top:16px} .section h3{margin:2px 0 10px;font-size:16px}
  .tag{display:inline-block;background:var(--card);border:1px solid var(--line);color:var(--muted);padding:2px 8px;border-radius:999px;margin-left:8px;font-size:12px}
  .theme-toggle{margin-left:auto} .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  .tip{font-size:12px;color:var(--muted);margin-top:6px} .toast{position:fixed;right:16px;bottom:16px;background:var(--panel);border:1px solid var(--line);padding:10px 14px;border-radius:10px;min-width:240px;display:none}
</style>

<div class="wrap">
  <h1>Accounts Admin <span id="authBadge" class="pill bad">Auth: failed</span>
    <button id="themeBtn" class="btn theme-toggle">Theme</button>
  </h1>

  <div class="panel controls">
    <div class="row">
      <div>
        <label>Admin API Key</label>
        <div class="row">
          <input id="adminKey" type="text" placeholder="admin.<secret>" class="mono" />
          <button id="saveKeyBtn" class="btn">Save</button>
          <button id="loadStatsBtn" class="btn brand">Load</button>
        </div>
        <div class="tip">Key localStorage me save hoti hai.</div>
      </div>
      <div><label>From</label><input id="fromDate" type="date"/></div>
      <div><label>To</label><input id="toDate" type="date"/></div>
      <div><label>Owner Keys (comma)</label><input id="ownerKeys" type="text" placeholder="sanjay,rahul,shoib"/></div>
    </div>
  </div>

  <div class="section panel">
    <div class="right" style="margin-bottom:8px"><button id="statsBtn" class="btn brand">Load Stats</button></div>
    <div id="totals" class="grid"></div>
    <div class="row section">
      <div class="panel" style="flex:1 1 520px">
        <h3>Per Owner</h3>
        <table class="table" id="perOwner"><thead></thead><tbody></tbody></table>
      </div>
      <div class="panel" style="flex:1 1 520px">
        <h3>Per Consumer</h3>
        <table class="table" id="perConsumer"><thead></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <div class="section panel">
    <div class="row" style="align-items:center;margin-bottom:6px">
      <h3 style="margin:0">Manage API Keys <span class="tag">create / update / regen</span></h3>
      <div class="right" style="margin-left:auto"><button id="keysRefreshBtn" class="btn">Refresh</button></div>
    </div>
    <table class="table" id="keysTable">
      <thead><tr><th>Key ID</th><th>Label</th><th>Active</th><th>Upload</th><th>Consume</th><th>RPM</th><th>Daily Cap</th><th>Created</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>

    <div class="section">
      <h3>Create New Key</h3>
      <div class="row">
        <div style="flex:1 1 160px"><label>key_id</label><input id="new_key_id" type="text" placeholder="team01" class="mono"></div>
        <div style="flex:1 1 220px"><label>label</label><input id="new_label" type="text" placeholder="Team 01"></div>
        <div style="flex:1 1 120px"><label>RPM</label><input id="new_rpm" type="number" value="60" min="1"></div>
        <div style="flex:1 1 140px"><label>Daily Cap</label><input id="new_cap" type="number" value="5000" min="1"></div>
        <div class="right" style="align-items:flex-end"><button id="createKeyBtn" class="btn ok">Create</button></div>
      </div>
    </div>
  </div>

  <div class="section panel">
    <div class="row" style="align-items:center;margin-bottom:6px">
      <h3 style="margin:0">Grants (Consumer → Owner)</h3>
      <div class="right" style="margin-left:auto"><button id="grantsRefreshBtn" class="btn">Refresh</button></div>
    </div>
    <table class="table" id="grantsTable">
      <thead><tr><th>Consumer</th><th>Owner</th><th>Enabled</th><th>Created</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="section">
      <h3>Add / Update Grant</h3>
      <div class="row">
        <div style="flex:1 1 220px"><label>consumer_key_id</label><input id="g_consumer" type="text" placeholder="rahul" class="mono"></div>
        <div style="flex:1 1 220px"><label>owner_key_id</label><input id="g_owner" type="text" placeholder="sanjay" class="mono"></div>
        <div class="right" style="align-items:flex-end">
          <button id="grantBtn" class="btn ok">Grant</button>
          <button id="revokeBtn" class="btn bad">Revoke</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
(() => {
  const $=s=>document.querySelector(s), ls={get(k,d=null){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}, set(k,v){localStorage.setItem(k,JSON.stringify(v))}};
  const ADMIN_KEY_INPUT=$('#adminKey'), AUTH_BADGE=$('#authBadge'), TOAST=$('#toast');

  function toast(m,t='info',ms=2500){TOAST.textContent=m;TOAST.style.display='block';clearTimeout(TOAST._t);TOAST._t=setTimeout(()=>TOAST.style.display='none',ms)}
  function esc(s){return String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
  function setAuthBadge(ok){AUTH_BADGE.classList.remove('ok','bad');AUTH_BADGE.classList.add(ok?'ok':'bad');AUTH_BADGE.textContent=ok?'Auth: ok':'Auth: failed'}
  function getKey(){const v=ADMIN_KEY_INPUT.value.trim();return v}
  async function api(url,{method='GET',body,params}={}){const k=getKey();if(!k||!k.includes('.'))throw new Error('Admin key format: admin.<secret>');const qs=params?('?'+new URLSearchParams(params)):'';
    const r=await fetch(url+qs,{method,headers:{'X-API-Key':k,...(body?{'Content-Type':'application/json'}:{})},body:body?JSON.stringify(body):undefined,cache:'no-store'});
    if(r.status===401){setAuthBadge(false);throw new Error('Unauthorized')} if(!r.ok){throw new Error(await r.text())} setAuthBadge(true); return r.headers.get('content-type')?.includes('json')?r.json():r.text()}

  function todayISO(d=0){const x=new Date(Date.now()+d*86400000);return x.toISOString().slice(0,10)}
  function initDates(){$('#fromDate').value=ls.get('from',todayISO(-11));$('#toDate').value=ls.get('to',todayISO(0));$('#ownerKeys').value=ls.get('owners','sanjay,rahul,shoib')}
  function saveKey(){const k=getKey(); if(!k.includes('.')) return toast('Format: admin.<secret>','error'); ls.set('admin_key',k); toast('Saved','ok')}
  function loadKey(){ADMIN_KEY_INPUT.value=ls.get('admin_key','')}

  function card(k,v){return `<div class="card"><div class="k">${k}</div><div class="v">${v}</div></div>`}
  function renderTotals(s){$('#totals').innerHTML=[card('Uploaded',s.totals?.uploaded??'—'),card('Unused',s.totals?.unused??'—'),card('Used total',s.totals?.used_total??'—'),card('Locked',s.totals?.locked??'—'),card('Reg success',s.totals?.reg_success??'—'),card('Code 282',s.totals?.code_282??'—')].join('')}
  function renderPerOwner(rows){$('#perOwner thead').innerHTML=`<tr><th>Owner</th><th>Uploaded</th><th>Unused</th><th>Used total</th><th>Locked</th><th>Reg success</th><th>Code 282</th><th>Used pending</th></tr>`;
    $('#perOwner tbody').innerHTML=rows.map(r=>`<tr><td class="mono">${esc(r.owner_key_id)}</td><td>${r.uploaded??0}</td><td>${r.unused??0}</td><td>${r.used_total??0}</td><td>${r.locked??0}</td><td>${r.reg_success??0}</td><td>${r.code_282??0}</td><td>${r.used_pending??0}</td></tr>`).join('')||`<tr><td colspan="8" class="muted">No data</td></tr>`}
  function renderPerConsumer(rows){$('#perConsumer thead').innerHTML=`<tr><th>Consumer Key</th><th>Used total</th></tr>`;
    $('#perConsumer tbody').innerHTML=rows.map(r=>`<tr><td class="mono">${esc(r.used_by_key)}</td><td>${r.total??0}</td></tr>`).join('')||`<tr><td colspan="2" class="muted">No data</td></tr>`}

  async function loadStats(){const from=$('#fromDate').value||todayISO(-11),to=$('#toDate').value||todayISO(0),owners=($('#ownerKeys').value||'').trim();ls.set('from',from);ls.set('to',to);ls.set('owners',owners);
    const p={date_from:from,date_to:to}; if(owners) p.owner_keys=owners; const s=await api('/v1/stats',{params:p}); renderTotals(s); renderPerOwner(s.per_owner||[]); renderPerConsumer(s.per_consumer||[]); toast('Stats loaded','ok',1200)}

  async function loadKeys(){const r=await api('/v1/admin/list_keys'); const tbody=$('#keysTable tbody'); tbody.innerHTML='';
    for(const k of (r.keys||[])){const tr=document.createElement('tr'); tr.innerHTML=`
        <td class="mono">${esc(k.key_id)}</td>
        <td><input data-f="label" type="text" value="${esc(k.label||'')}" /></td>
        <td><input data-f="active" type="checkbox" ${k.active?'checked':''}/></td>
        <td><input data-f="can_upload" type="checkbox" ${k.can_upload?'checked':''}/></td>
        <td><input data-f="can_consume" type="checkbox" ${k.can_consume?'checked':''}/></td>
        <td><input data-f="rpm_limit" type="number" value="${k.rpm_limit??60}" style="width:90px"/></td>
        <td><input data-f="daily_cap" type="number" value="${k.daily_cap??0}" style="width:110px"/></td>
        <td class="mono">${esc(k.created_at||'')}</td>
        <td><div class="right"><button class="btn" data-act="save">Save</button><button class="btn warn" data-act="regen">Regen</button></div></td>`;
      tr.querySelector('[data-act="save"]').onclick=()=>updateKeyRow(k.key_id,tr);
      tr.querySelector('[data-act="regen"]').onclick=()=>regenSecret(k.key_id);
      tbody.appendChild(tr)
    } }

  async function updateKeyRow(id,tr){const g=f=>{const el=tr.querySelector(`[data-f="${f}"]`); if(!el) return; if(el.type==='checkbox') return el.checked?1:0; if(el.type==='number') return Number(el.value||0); return el.value};
    await api('/v1/admin/update_key',{method:'POST',body:{key_id:id,label:g('label'),active:g('active'),can_upload:g('can_upload'),can_consume:g('can_consume'),rpm_limit:g('rpm_limit'),daily_cap:g('daily_cap')}}); toast('Saved','ok'); loadKeys()}
  async function regenSecret(id){if(!confirm(`Regenerate secret for ${id}?`)) return; const x=await api('/v1/admin/regen_secret',{method:'POST',body:{key_id:id}}); if(x.api_key){await navigator.clipboard.writeText(x.api_key).catch(()=>{}); toast('New key copied','ok',4000)}}

  async function loadGrants(){const r=await api('/v1/admin/list_grants'); const tb=$('#grantsTable tbody');
    tb.innerHTML=(r.grants||[]).map(g=>`<tr><td class="mono">${esc(g.consumer_key_id)}</td><td class="mono">${esc(g.owner_key_id)}</td><td>${g.enabled?1:0}</td><td class="mono">${esc(g.created_at||'')}</td><td><div class="right"><button class="btn ok" data-c="${esc(g.consumer_key_id)}" data-o="${esc(g.owner_key_id)}" data-act="grant">Grant</button><button class="btn bad" data-c="${esc(g.consumer_key_id)}" data-o="${esc(g.owner_key_id)}" data-act="revoke">Revoke</button></div></td></tr>`).join('')||`<tr><td colspan="5" class="muted">No grants</td></tr>`;
    tb.querySelectorAll('[data-act="grant"]').forEach(b=>b.onclick=()=>grant(b.dataset.c,b.dataset.o));
    tb.querySelectorAll('[data-act="revoke"]').forEach(b=>b.onclick=()=>revoke(b.dataset.c,b.dataset.o));
  }
  async function grant(c,o){c=c||$('#g_consumer').value.trim();o=o||$('#g_owner').value.trim(); if(!c||!o) return toast('consumer & owner required','error'); await api('/v1/admin/grant',{method:'POST',body:{consumer_key_id:c,owner_key_id:o,enabled:1}}); toast('Granted','ok'); $('#g_consumer').value=''; $('#g_owner').value=''; loadGrants()}
  async function revoke(c,o){c=c||$('#g_consumer').value.trim();o=o||$('#g_owner').value.trim(); if(!c||!o) return toast('consumer & owner required','error'); await api('/v1/admin/revoke',{method:'POST',body:{consumer_key_id:c,owner_key_id:o}}); toast('Revoked','ok'); $('#g_consumer').value=''; $('#g_owner').value=''; loadGrants()}

  function applyTheme(){const t=ls.get('theme','dark'); document.documentElement.classList.toggle('light', t==='light'); $('#themeBtn').textContent=(t==='light')?'Dark':'Light'}
  function toggleTheme(){ls.set('theme', ls.get('theme','dark')==='light'?'dark':'light'); applyTheme()}

  // init
  (function start(){
    applyTheme(); loadKey(); initDates();
    $('#themeBtn').onclick=toggleTheme; $('#saveKeyBtn').onclick=()=>{saveKey(); checkAuth()}; $('#loadStatsBtn,#statsBtn').forEach?null:0;
    document.querySelector('#loadStatsBtn').onclick=()=>{saveKey(); loadStats()};
    document.querySelector('#statsBtn').onclick=loadStats; document.querySelector('#keysRefreshBtn').onclick=loadKeys;
    document.querySelector('#grantsRefreshBtn').onclick=loadGrants; document.querySelector('#createKeyBtn').onclick=createKey;
    document.querySelector('#grantBtn').onclick=()=>grant(); document.querySelector('#revokeBtn').onclick=()=>revoke();
    checkAuth().then(()=>{loadStats().catch(()=>{}); loadKeys().catch(()=>{}); loadGrants().catch(()=>{})});
  })();

  async function checkAuth(){try{await api('/v1/admin/list_keys'); setAuthBadge(true)}catch{setAuthBadge(false)}}
})();
</script>
<script>
/* ===== Admin autoload boot (keeps you logged in after refresh) ===== */
(function () {
  const LS_KEY = 'admin_api_key_v1';

  function qs(sel){ return document.querySelector(sel); }
  // yeh IDs/func names aapke current admin.html se match karte hain:
  const keyInput = qs('#adminKey') || qs('input[data-admin-key]');

  // unified way to set current auth header for all fetches
  function setAuth(key){
    window.__ADMIN_KEY__ = key;
    window.__AUTH_HEADER__ = { 'X-API-Key': key };
    if (typeof setAuthBadge === 'function') setAuthBadge('pending'); // UI badge update (optional)
  }

  async function loadAll(){
    const jobs = [];
    if (typeof loadStats === 'function')        jobs.push(loadStats());
    if (typeof refreshKeys === 'function')      jobs.push(refreshKeys());
    if (typeof refreshGrants === 'function')    jobs.push(refreshGrants());
    // quietly settle (UI me jo available hai wo aa jayega)
    await Promise.allSettled(jobs);
    if (typeof setAuthBadge === 'function') setAuthBadge('ok');
  }

  // Save button helper (agar aapke code me saveKey hai to usko wrap)
  window.saveAdminKey = async function(){
    const k = (keyInput?.value || '').trim();
    if (!k) { alert('Please paste admin API key'); return; }
    localStorage.setItem(LS_KEY, k);
    setAuth(k);
    await loadAll();
  };

  // Enter key => save + load
  if (keyInput) {
    keyInput.addEventListener('keydown', (e)=> {
      if (e.key === 'Enter') { e.preventDefault(); window.saveAdminKey(); }
    });
  }

  // ---- BOOTSTRAP on first paint ----
  document.addEventListener('DOMContentLoaded', async () => {
    // 1) pick key from localStorage
    const saved = localStorage.getItem(LS_KEY);
    if (saved) {
      if (keyInput) keyInput.value = saved;
      setAuth(saved);
      // 2) auto fetch everything so UI prefilled rahe
      await loadAll();
    } else {
      if (typeof setAuthBadge === 'function') setAuthBadge('failed');
    }
  });

  // expose small helper so existing "Load" button chahe to ise call kar sake
  window.adminAutoLoad = loadAll;
})();
</script>
<script>
/* ===== keep-admin-logged-in: auto header + auto load on refresh ===== */
(function(){
  const LS = 'admin_api_key_v1';
  const getKey = () => (localStorage.getItem(LS) || '').trim();
  const setKey = (k) => localStorage.setItem(LS, (k||'').trim());

  // 1) Monkey-patch fetch: always attach X-API-Key from localStorage
  const _fetch = window.fetch.bind(window);
  window.fetch = (input, init = {}) => {
    init = init || {};
    const headers = new Headers(init.headers || {});
    const k = getKey();
    if (k) headers.set('X-API-Key', k);
    init.headers = headers;
    return _fetch(input, init);
  };

  // --- helpers to find key input & click buttons by text ---
  function findAdminInput(){
    let inp = null;
    document.querySelectorAll('label').forEach(l=>{
      if (!inp && /admin\s*api\s*key/i.test(l.textContent)) {
        inp = l.parentElement?.querySelector('input');
      }
    });
    return inp || document.querySelector('.controls input') || document.querySelector('input');
  }
  function clickButtonsByText(txt){
    const want = txt.toLowerCase();
    document.querySelectorAll('button, input[type="button"]').forEach(b=>{
      const label = (b.textContent || b.value || '').trim().toLowerCase();
      if (label === want) b.click();
    });
  }

  // 2) Wire Save/Load buttons to persist key as well
  function wireSaveLoadPersist(){
    document.querySelectorAll('button, input[type="button"]').forEach(b=>{
      const label = (b.textContent || b.value || '').trim().toLowerCase();
      if (label === 'save' || label === 'load') {
        b.addEventListener('click', ()=>{
          const v = findAdminInput()?.value || '';
          setKey(v);
        }, { once:false });
      }
    });
  }

  // 3) On boot: fill input from localStorage and auto-load panels
  document.addEventListener('DOMContentLoaded', ()=>{
    const k = getKey();
    const inp = findAdminInput();
    if (inp && k && !inp.value) inp.value = k;

    wireSaveLoadPersist();

    if (k) {
      // kick all data loads so UI prefilled rahe
      clickButtonsByText('load stats');
      clickButtonsByText('refresh');        // keys table
      setTimeout(()=>clickButtonsByText('refresh'), 200); // grants table (second refresh on page)
    }
  });
})();
</script>
